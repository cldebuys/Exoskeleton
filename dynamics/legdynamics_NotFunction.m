% function dx = legdynamics(t,x,P)
clear all;
jnt_data = load('JntAngS01_TRIAL_06');
elev_data = load('ElevAngS01_TRIAL_06');

Joints = jnt_data.JntAngS01_TRIAL_06(:,1:4);     % [KneeLAng KneeRAng HipLRAng HipRAng]
Ankles = elev_data.ElevAngS01_TRIAL_06(:,6:7);    % [AnkleLAng AnkleRAng]

x(1:3,:) = [Joints(:,3) Joints(:,1) Ankles(:,1)]'; %% make sure angles have correct reference
x(4,:) = gradient(x(1,:));  %
x(5,:) = gradient(x(2,:));  % % velocities
x(6,:) = gradient(x(3,:));  %

P = ones(1,15); %%
P = [30 15 5 20 10 2 1 1 1 0.3 0.2 0.05 0.15 0.1 0.025];

I1 = P(1);      I2 = P(2);      I3 = P(3); 
m1 = P(4);      m2 = P(5);      m3 = P(6);      
C1 = P(7);      C2 = P(8);      C3 = P(9);      
l1 = P(10);     l2 = P(11);     l3 = P(12);
lc1 = P(13);    lc2 = P(14);    lc3 = P(15);
g = 9.81;

% q are relative joint angles (theta2 = q1 + q2)

dx(1,:) = x(4,:);
dx(2,:) = x(5,:);
dx(3,:) = x(6,:);
dx(4,:) = gradient(dx(1,:)); %
dx(5,:) = gradient(dx(2,:)); % % accelerations
dx(6,:) = gradient(dx(3,:)); %

% Joint torques (hip, knee, ankle)
tau1 = g.*lc1.*m1.*cos(x(1,:))+g.*l1.*m2.*cos(x(1,:))+g.*l1.*m3.*cos(x(1,:))+ ...
  g.*lc2.*m2.*cos(x(1,:)+x(2,:))+g.*l2.*m3.*cos(x(1,:)+x(2,:))+g.*lc3.*m3.* ...
  cos(x(1,:)+x(2,:)+x(3,:))+0.1E1.*I1.*dx(4,:)+0.1E1.*I2.*dx(4,:)+0.1E1.*I3.* ...
  dx(4,:)+0.1E1.*l1.^2.*m1.*dx(4,:)+0.1E1.*l1.^2.*m2.*dx(4,:)+0.1E1.* ...
  l2.^2.*m2.*dx(4,:)+0.1E1.*l1.^2.*m3.*dx(4,:)+0.1E1.*l2.^2.*m3.*dx(4,:)+ ...
  0.1E1.*lc3.^2.*m3.*dx(4,:)+0.2E1.*l1.*l2.*m2.*cos(x(2,:)).*dx(4,:)+ ...
  0.2E1.*l1.*l2.*m3.*cos(x(2,:)).*dx(4,:)+0.2E1.*l2.*lc3.*m3.*cos(x(3,:)) ...
  .*dx(4,:)+0.2E1.*l1.*lc3.*m3.*cos(x(2,:)+x(3,:)).*dx(4,:)+0.1E1.*I2.*dx(5,:) ...
  +0.1E1.*I3.*dx(5,:)+0.1E1.*l2.^2.*m2.*dx(5,:)+0.1E1.*l2.^2.*m3.*dx(5,:)+ ...
  0.1E1.*lc3.^2.*m3.*dx(5,:)+0.1E1.*l1.*l2.*m2.*cos(x(2,:)).*dx(5,:)+ ...
  0.1E1.*l1.*l2.*m3.*cos(x(2,:)).*dx(5,:)+0.2E1.*l2.*lc3.*m3.*cos(x(3,:)) ...
  .*dx(5,:)+0.1E1.*l1.*lc3.*m3.*cos(x(2,:)+x(3,:)).*dx(5,:)+0.1E1.*I3.*dx(6,:) ...
  +0.1E1.*lc3.^2.*m3.*dx(6,:)+0.1E1.*l2.*lc3.*m3.*cos(x(3,:)).*dx(6,:)+ ...
  0.1E1.*l1.*lc3.*m3.*cos(x(2,:)+x(3,:)).*dx(6,:)+(-0.2E1).*l1.*l2.*m2.* ...
  sin(x(2,:)).*x(4,:).*x(5,:)+(-0.2E1).*l1.*l2.*m3.*sin(x(2,:)).*x(4,:).*x(5,:)+ ...
  (-0.2E1).*l1.*lc3.*m3.*sin(x(2,:)+x(3,:)).*x(4,:).*x(5,:)+(-0.1E1).*l1.* ...
  l2.*m2.*sin(x(2,:)).*x(5,:).^2+(-0.1E1).*l1.*l2.*m3.*sin(x(2,:)).*x(5,:) ...
  .^2+(-0.1E1).*l1.*lc3.*m3.*sin(x(2,:)+x(3,:)).*x(5,:).^2+(-0.2E1).*l2.* ...
  lc3.*m3.*sin(x(3,:)).*x(4,:).*x(6,:)+(-0.2E1).*l1.*lc3.*m3.*sin(x(2,:)+x( ...
  3)).*x(4,:).*x(6,:)+(-0.2E1).*l2.*lc3.*m3.*sin(x(3,:)).*x(5,:).*x(6,:)+( ...
  -0.2E1).*l1.*lc3.*m3.*sin(x(2,:)+x(3,:)).*x(5,:).*x(6,:)+(-0.1E1).*l2.* ...
  lc3.*m3.*sin(x(3,:)).*x(6,:).^2+(-0.1E1).*l1.*lc3.*m3.*sin(x(2,:)+x(3,:)) ...
  .*x(6,:).^2;

tau2 = g.*lc2.*m2.*cos(x(1,:)+x(2,:))+g.*l2.*m3.*cos(x(1,:)+x(2,:))+g.*lc3.*m3.* ...
  cos(x(1,:)+x(2,:)+x(3,:))+0.1E1.*I2.*dx(4,:)+0.1E1.*I3.*dx(4,:)+0.1E1.* ...
  l2.^2.*m2.*dx(4,:)+0.1E1.*l2.^2.*m3.*dx(4,:)+0.1E1.*lc3.^2.*m3.*dx(4,:)+ ...
  0.1E1.*l1.*l2.*m2.*cos(x(2,:)).*dx(4,:)+0.1E1.*l1.*l2.*m3.*cos(x(2,:)).* ...
  dx(4,:)+0.2E1.*l2.*lc3.*m3.*cos(x(3,:)).*dx(4,:)+0.1E1.*l1.*lc3.*m3.* ...
  cos(x(2,:)+x(3,:)).*dx(4,:)+0.1E1.*I2.*dx(5,:)+0.1E1.*I3.*dx(5,:)+0.1E1.* ...
  l2.^2.*m2.*dx(5,:)+0.1E1.*l2.^2.*m3.*dx(5,:)+0.1E1.*lc3.^2.*m3.*dx(5,:)+ ...
  0.2E1.*l2.*lc3.*m3.*cos(x(3,:)).*dx(5,:)+0.1E1.*I3.*dx(6,:)+0.1E1.* ...
  lc3.^2.*m3.*dx(6,:)+0.1E1.*l2.*lc3.*m3.*cos(x(3,:)).*dx(6,:)+0.1E1.*l1.* ...
  l2.*m2.*sin(x(2,:)).*x(4,:).^2+0.1E1.*l1.*l2.*m3.*sin(x(2,:)).*x(4,:).^2+ ...
  0.1E1.*l1.*lc3.*m3.*sin(x(2,:)+x(3,:)).*x(4,:).^2+(-0.2E1).*l2.*lc3.* ...
  m3.*sin(x(3,:)).*x(4,:).*x(6,:)+(-0.2E1).*l2.*lc3.*m3.*sin(x(3,:)).*x(5,:).* ...
  x(6,:)+(-0.1E1).*l2.*lc3.*m3.*sin(x(3,:)).*x(6,:).^2;

tau3 = g.*lc3.*m3.*cos(x(1,:)+x(2,:)+x(3,:))+0.1E1.*I3.*dx(4,:)+0.1E1.*lc3.^2.* ...
  m3.*dx(4,:)+0.1E1.*l2.*lc3.*m3.*cos(x(3,:)).*dx(4,:)+0.1E1.*l1.*lc3.* ...
  m3.*cos(x(2,:)+x(3,:)).*dx(4,:)+0.1E1.*I3.*dx(5,:)+0.1E1.*lc3.^2.*m3.*dx( ...
  5)+0.1E1.*l2.*lc3.*m3.*cos(x(3,:)).*dx(5,:)+0.1E1.*I3.*dx(6,:)+0.1E1.* ...
  lc3.^2.*m3.*dx(6,:)+0.1E1.*l2.*lc3.*m3.*sin(x(3,:)).*x(4,:).^2+0.1E1.* ...
  l1.*lc3.*m3.*sin(x(2,:)+x(3,:)).*x(4,:).^2+0.2E1.*l2.*lc3.*m3.*sin(x(3,:)) ...
  .*x(4,:).*x(5,:)+0.1E1.*l2.*lc3.*m3.*sin(x(3,:)).*x(5,:).^2;

% end
